---
description: API contracts and data schemas
globs: ["packages/core/**/*.ts", "packages/lambda/**/*.ts"]
alwaysApply: false
---

# API Contracts

## Chat Endpoint

### Request: `POST /chat`

```typescript
{
  userMessage: string;
  conversationState?: {
    filters?: Record<string, unknown>;
    prefs?: Record<string, unknown>;
  };
}
```

### Response

```typescript
{
  answer: string;
  recommendations: Array<{
    id: number;
    title: string;
    url: string;
    price: number;
    image: string;
    reason: string;
  }>;
  debug?: {
    bm25Top: unknown[];
    semanticTop: unknown[];
    fusedTop: unknown[];
  };
}
```

**Stability:** `answer` + `recommendations` should remain stable across versions.

## Normalized Product Schema

All retrieval operates on this normalized schema (see `packages/core/src/lib/types.ts`):

### Required Fields
```typescript
{
  id: number;
  title: string;
  url: string;
  vendor: string;
  product_type: string;
  tags: string[];
  available: boolean;
  price_min: number;
  price_max: number;
  images: { src: string }[];
  description_text: string;
  doc_text: string;  // used by BM25 & embeddings
}
```

### Optional Fields
```typescript
{
  variants?: { sku?: string; price?: number; available?: boolean }[];
  attributes?: Record<string, any>;  // inferred specs
  embedding?: number[];  // typically stored separately
}
```

**Schema Changes:** Must be backwards-compatible or include migration plan + artifact rebuild.

## Hard Filters (applied after fusion)
- `available_only: boolean`
- `max_price: number`
- `vendor: string`
- `product_type: string`
- `include_tags: string[]`
- `exclude_tags: string[]`
